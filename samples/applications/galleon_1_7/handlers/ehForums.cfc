<!-----------------------------------------------------------------------Author 	 :	Luis MajanoDate     :	September 25, 2005Description :	The galleon port.-----------------------------------------------------------------------><cfcomponent name="ehForums" extends="coldbox.system.eventhandler">	<!--- ************************************************************* --->	<cffunction name="onAppStart" access="public" returntype="void" output="false">		<!--- App Init Code --->		<cfset structDelete(application, "userCache")>		<!--- Get main settings --->		<cfinvoke component="#getSetting("AppMapping")#/cfcs/galleon" method="getSettings" returnVariable="settings">		<cfset application.settings = settings>				<!--- Attachment Directory --->		<cfset application.settings.attachmentdir = expandPath("./attachments")>		<cfif not directoryExists(application.settings.attachmentdir)>			<cfdirectory action="create" directory="#application.settings.attachmentdir#">		</cfif>				<!--- get user CFC --->		<cfset application.user = createObject("component","#getSetting("AppMapping")#.cfcs.user").init(application.settings)>		<!--- get utils CFC --->		<cfset application.utils = createObject("component","#getSetting("AppMapping")#.cfcs.utils")>		<!--- get conference CFC --->		<cfset application.conference = createObject("component","#getSetting("AppMapping")#.cfcs.conference").init(application.settings)>		<!--- get forum CFC --->		<cfset application.forum = createObject("component","#getSetting("AppMapping")#.cfcs.forum").init(application.settings)>		<!--- get thread CFC --->		<cfset application.thread = createObject("component","#getSetting("AppMapping")#.cfcs.thread").init(application.settings)>		<!--- get message CFC --->		<cfset application.message = createObject("component","#getSetting("AppMapping")#.cfcs.message").init(application.settings)>		<!--- get rank CFC --->		<cfset application.rank = createObject("component","#getSetting("AppMapping")#.cfcs.rank").init(application.settings)>		<cfset application.init = true>			</cffunction>		<!--- ************************************************************* --->		<cffunction name="onRequestStart" access="public" returntype="void" output="false">		<!--- Logout Code --->		<cfif valueExists("logout")>			<cfset runEvent("ehUsers.doLogout")>		</cfif>		<!--- handle security --->		<cflogin></cflogin>		<!--- Used by index, forums, and threads ---->		<!--- however, if threads, default to lastpost --->		<!--- however, don't do this in the admin ;) --->		<!---<cfif not findNoCase("/admin", cgi.script_name)> --->			<cfif findNoCase("dspThreads", cgi.script_name)>				<cfset paramValue("sort", "lastpost")>				<cfset paramValue("sortdir", "desc")>			<cfelse>				<cfset paramValue("sort", "name")>				<cfset paramValue("sortdir", "asc")>			</cfif>		<!---</cfif> --->				<!--- EXIT HANDLERS: --->		<cfset rc.xehProfile = "ehUsers.dspProfile" >		<cfset rc.xehSearch = "ehForums.dspSearch">		<cfset rc.xehLogin = "ehUsers.dspLogin">		<cfset rc.xehRSS = "ehForums.dspRss">	</cffunction>		<!--- ************************************************************* --->	<cffunction name="dspHome" access="public" returntype="void" output="false">		<!--- EXIT HANDLERS: --->		<cfset rc.xehForums = "ehForums.dspForums">		<cfset rc.xehMessages = "ehMessages.dspMessages">		<!--- get my conferences --->		<cfset rc.data = application.conference.getConferences()>		<!--- if just one, auto go to a forums for it --->		<cfif rc.data.recordCount is 1>			<cfset setNextEvent("ehForums.dspForums","conferenceid=#rc.data.id#")>		</cfif>		<!--- sort --->		<cfset rc.data = request.udf.querySort(rc.data,getValue("sort"),getValue("sortdir"))>		<!--- determine max pages --->		<cfif rc.data.recordCount and rc.data.recordCount gt application.settings.perpage>			<cfset setValue("pages",ceiling(rc.data.recordCount / application.settings.perpage)) >		<cfelse>			<cfset setValue("pages",1)>		</cfif>		<!--- Set Title and Templatename --->		<cfset setValue("title","#application.settings.title#")>		<cfset setValue("templatename","main")>		<!--- Set the View To Display, after Logic --->		<cfset setView("vwIndex")>	</cffunction>		<!--- ************************************************************* --->		<cffunction name="dspForums" access="public" returntype="void" output="false">		<!--- EXIT HANDLERS: --->		<cfset rc.xehForums = "ehForums.dspForums">		<cfset rc.xehThreads = "ehForums.dspThreads">		<cfset rc.xehMessages = "ehMessages.dspMessages">		<!--- Check for Conference --->		<cfif not valueExists("conferenceid") or not len(getValue("conferenceid"))>			<cfset setnextEvent("ehForums.dspHome")>		</cfif>		<!--- get parent conference --->		<cftry>			<cfset request.conference = application.conference.getConference(getValue("conferenceid"))>			<cfcatch>				<cfset getPlugin("logger").logError("Error retreiving parent conference", cfcatch )>				<cfset setnextEvent("ehForums.dspHome")>			</cfcatch>		</cftry>		<!--- get my forums --->		<cfset rc.data = application.forum.getForums(conferenceid=Getvalue("conferenceid")) >		<!--- sort --->		<cfset rc.data = request.udf.querySort(rc.data,getValue("sort"),getValue("sortdir")) >		<!--- determine max pages --->		<cfif rc.data.recordCount and rc.data.recordCount gt application.settings.perpage>			<cfset setValue("pages", ceiling(rc.data.recordCount / application.settings.perpage) )>		<cfelse>			<cfset setValue("pages", 1)>		</cfif>		<!--- Set Title and Templatename --->		<cfset setValue("title","#application.settings.title# : #request.conference.name#")>		<cfset setValue("templatename","main")>		<!--- Set the View To Display, after Logic --->		<cfset setView("vwForums")>	</cffunction>		<!--- ************************************************************* --->		<cffunction name="dspThreads" access="public" returntype="void" output="false">		<!--- EXIT HANDLERS: --->		<cfset rc.xehForums = "ehForums.dspForums">		<cfset rc.xehThreads = "ehForums.dspThreads">		<cfset rc.xehMessages = "ehMessages.dspMessages">		<cfset rc.xehNewPost = "ehMessages.dspNewPost">				<!--- Chek for forum id --->			<cfif not valueExists("forumid") or not len(getValue("forumid"))>			<cfset setNextEvent("ehForums.dspHome")>		</cfif>		<!--- get parents --->		<cftry>			<cfset request.forum = application.forum.getForum(getValue("forumid"))>			<cfset request.conference = application.conference.getConference(request.forum.conferenceidfk)>			<cfcatch>				<cfset getPlugin("logger").logError("Error getting forums and conferences information", cfcatch)>				<cfset setNextEvent("ehForums.dspHome")>			</cfcatch>		</cftry>		<!--- get my threads --->		<cfset rc.data = application.thread.getThreads(forumid=getvalue("forumid"))>		<!--- sort --->		<cfset rc.data = request.udf.querySort(rc.data,getValue("sort"),getValue("sortdir"))>		<!--- determine max pages --->		<cfif rc.data.recordCount and rc.data.recordCount gt application.settings.perpage>			<cfset setValue("pages",ceiling(rc.data.recordCount / application.settings.perpage))>		<cfelse>			<cfset setValue("pages",1)>		</cfif>		<!--- Set Title and Templatename --->		<cfset setValue("title","#application.settings.title# : #request.conference.name# : #request.forum.name#")>		<cfset setValue("templatename","main")>		<!--- Set the View To Display, after Logic --->		<cfset setView("vwThreads")>	</cffunction>	<!--- ************************************************************* --->		<cffunction name="dspSearch" access="public" returntype="void" output="false">		<!--- EXIT HANDLERS: --->		<cfset rc.xehDoSearch = "ehForums.doSearch">		<cfset rc.xehForums = "ehForums.dspForums">		<cfset rc.xehThreads = "ehForums.dspThreads">		<cfset rc.xehMessages = "ehMessages.dspMessages">				<!--- Param values --->		<cfset paramValue("searchterms","")>		<cfset paramValue("searchtype","phrase")>		<cfset rc.searchterms = trim(htmlEditFormat(application.utils.searchSafe(rc.searchterms)))>				<!--- Set Title and Templatename --->		<cfset setValue("title","#application.settings.title# : Search")>		<cfset setValue("templatename","main")>		<!--- Set the View To Display, after Logic --->		<cfset setView("vwSearch")>	</cffunction>		<!--- ************************************************************* --->		<cffunction name="doSearch" access="public" returntype="void" output="false">		<!--- Handle attempted search --->		<cfif not listFindNoCase("phrase,any,all", getValue("searchtype",""))>			<cfset setValue("searchtype","phrase")>		</cfif>		<!---			search multiple items:				conferences (name/desc)				forums (name/desc)				threads (name)				messages (title/body)		--->		<cfset setValue("conferences", application.conference.search(getValue("searchterms"), getValue("searchtype")))>		<cfset setValue("forums", application.forum.search(getValue("searchterms"), getValue("searchtype")))>		<cfset setValue("threads", application.thread.search(getValue("searchterms"), getValue("searchtype")))>		<cfset setValue("messages", application.message.search(getValue("searchterms"), getValue("searchtype")))>				<cfset application.utils.logSearch(getValue("searchterms"), application.settings.dsn, application.settings.tableprefix)>		<cfset setValue("totalResults",getValue("conferences").recordCount + getValue("forums").recordCount + getValue("threads").recordCount + getValue("messages").recordCount)>				<!--- Display Results --->		<cfset dspSearch()>		<cfreturn>	</cffunction>	<!--- ************************************************************* --->	<!--- ************************************************************* --->	<cffunction name="dspRss" access="public" returntype="void" output="false">		<cfif not valueExists("conferenceid") or not len(getValue("conferenceid"))>			<cfset setNextEvent("ehForums.dspHome")>		</cfif>		<!--- get parent conference --->		<cftry>			<cfset request.conference = application.conference.getConference(getValue("conferenceid"))>			<cfcatch>				<cfset setNextEvent("ehForums.dspHome")>			</cfcatch>		</cftry>		<!--- get my latest posts --->		<cfset setValue("data", application.conference.getLatestPosts(conferenceid=getValue("conferenceid")))>		<!--- Set the View To Display, after Logic --->		<cfset setView("vwRss")>	</cffunction>		<!--- ************************************************************* --->		</cfcomponent>